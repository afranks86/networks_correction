---
title: "expressionPC_covariate_R2"
output: html_notebook
---


```{r}
library(recount)
library(ggplot2)
library(RColorBrewer)
library(reshape2)

load("../data/pc_loadings.Rdata")
load("../data/raw_protein_coding_withGC.Rdata")

## none of the covariates have NA --> total sum of squares can be computed before hand
dat.cov <- lapply(gtex.rse, function(tiss) {
  cov.dat <- tiss@colData[,c(10, 11, 21:80, 83)]
  cov.dat <- cov.dat[,-which(sapply(cov.dat, function(x) length(unique(x))) == 1)]
  cov.dat <- cov.dat[, -which(colnames(cov.dat) %in% c("smunpdrd","smpthnts", "smtstptref", "smnabtch", "smnabtchd", "smgebtch"))] ## not enought unique entries in more than one category, < 50
  cov.dat
})

pve.tissue <- mapply(function(x,y,z){
  pve.eachtiss <- matrix(ncol = z, nrow = ncol(y))
  for(i in 1:ncol(y)){
    pve.eachtiss[i,] <- sapply(summary(lm(x[,1:z]~y[,i])), function(p) p$r.squared)
  }
  colnames(pve.eachtiss) <- 1:z
  rownames(pve.eachtiss) <- colnames(y)
  pve.eachtiss
}, pc.loadings, dat.cov, num.pc.estimates, SIMPLIFY = FALSE)

plot.r2 <- lapply(pve.tissue, melt)
```

```{r}
myPalette <- colorRampPalette(brewer.pal(9,'Blues'), space = "Lab")

tiss<- "Subcutaneous"

ggplot(plot.r2[[tiss]], aes(Var2, Var1)) + geom_tile(aes(fill = value),
	     colour = "white") + 
		# geom_text(size = 2, aes(label = prettyNum(value, digits=3, width=4, format="fg"))) +
		scale_fill_gradientn(colours = myPalette(10)[1:6]
			, limits = c(0,1)
		, values = c(0, 0.1, 0.2, 0.3, 1)
		) + 
		xlab("") + ylab("Principal Components") + theme(axis.text.x=element_text(colour="black"), axis.text.y=element_text(colour="black"))+
		ggtitle(tiss)
```
```{r}
tiss<- "Lung"

ggplot(plot.r2[[tiss]], aes(Var2, Var1)) + geom_tile(aes(fill = value),
	     colour = "white") + 
		# geom_text(size = 2, aes(label = prettyNum(value, digits=3, width=4, format="fg"))) +
		scale_fill_gradientn(colours = myPalette(10)[1:6]
			, limits = c(0,1)
		, values = c(0, 0.1, 0.2, 0.3, 1)
		) + 
		xlab("") + ylab("Principal Components") + theme(axis.text.x=element_text(colour="black"), axis.text.y=element_text(colour="black"))+
		ggtitle(tiss)
```

```{r}
tiss<- "Thyroid"

ggplot(plot.r2[[tiss]], aes(Var2, Var1)) + geom_tile(aes(fill = value),
	     colour = "white") + 
		# geom_text(size = 2, aes(label = prettyNum(value, digits=3, width=4, format="fg"))) +
		scale_fill_gradientn(colours = myPalette(10)[1:6]
			, limits = c(0,1)
		, values = c(0, 0.1, 0.2, 0.3, 1)
		) + 
		xlab("") + ylab("Principal Components") + theme(axis.text.x=element_text(colour="black"), axis.text.y=element_text(colour="black"))+
		ggtitle(tiss)
```

```{r}
tiss<- "Muscle"
ggplot(plot.r2[[tiss]], aes(Var2, Var1)) + geom_tile(aes(fill = value),
	     colour = "white") + 
		# geom_text(size = 2, aes(label = prettyNum(value, digits=3, width=4, format="fg"))) +
		scale_fill_gradientn(colours = myPalette(10)[1:6]
			, limits = c(0,1)
		, values = c(0, 0.1, 0.2, 0.3, 1)
		) + 
		xlab("") + ylab("Principal Components") + theme(axis.text.x=element_text(colour="black"), axis.text.y=element_text(colour="black"))+
		ggtitle(tiss)
```

```{r}
tiss<- "Blood"

ggplot(plot.r2[[tiss]], aes(Var2, Var1)) + geom_tile(aes(fill = value),
	     colour = "white") + 
		# geom_text(size = 2, aes(label = prettyNum(value, digits=3, width=4, format="fg"))) +
		scale_fill_gradientn(colours = myPalette(10)[1:6]
			, limits = c(0,1)
		, values = c(0, 0.1, 0.2, 0.3, 1)
		) + 
		xlab("") + ylab("Principal Components") + theme(axis.text.x=element_text(colour="black"), axis.text.y=element_text(colour="black"))+
		ggtitle(tiss)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

